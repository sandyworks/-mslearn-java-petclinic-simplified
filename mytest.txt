#!/bin/bash

# Input file containing machine names, one per line
input_file="machine_names.txt"

# Function to check the number of nodes in the ready state
function get_ready_node_count() {
  oc get nodes --no-headers | awk '$2 == "Ready" { count++ } END { print count }'
}

# Loop through each machine name in the input file
while IFS= read -r machine_name; do
  echo "Deleting machine: $machine_name"
  oc delete machine "$machine_name"
  
  # Get the initial number of ready nodes
  original_ready_nodes=$(get_ready_node_count)
  
  # Wait for the machine to be recreated
  while true; do
    running_machines=$(oc get machines --no-headers | grep -c "Running")
    
    if [ "$running_machines" -eq "$original_running_machines" ]; then
      echo "Machine $machine_name recreated."
      break
    fi
    
    sleep 10
  done

  # Wait for the number of ready nodes to be the same as before
  while true; do
    current_ready_nodes=$(get_ready_node_count)
    
    if [ "$current_ready_nodes" -eq "$original_ready_nodes" ]; then
      echo "All nodes are in Ready state."
      break
    fi
    
    sleep 10
  done

done < "$input_file"

echo "All machines have been deleted and recreated."
